from fastapi import FastAPI
from pydantic import BaseModel
import uvicorn
import os

from transformers import (
    TFAutoModelForSequenceClassification,
    AutoTokenizer
)
import tensorflow as tf
from googletrans import Translator

class SymptomRequest(BaseModel):
    symptoms: str

app = FastAPI()

# Глобальні змінні
classifier_model = None
classifier_tokenizer = None
translator = Translator()

# BERT: індекс -> діагноз (англ.)
id2label = {
    0: "allergy",
    1: "arthritis",
    2: "bronchial asthma",
    3: "cervical spondylosis",
    4: "chicken pox",
    5: "common cold",
    6: "dengue",
    7: "diabetes",
    8: "drug reaction",
    9: "fungal infection",
    10: "gastroesophageal reflux disease",
    11: "hypertension",
    12: "impetigo",
    13: "jaundice",
    14: "malaria",
    15: "migraine",
    16: "peptic ulcer disease",
    17: "pneumonia",
    18: "psoriasis",
    19: "typhoid",
    20: "urinary tract infection",
    21: "varicose veins"
}

# Англ -> Укр для діагнозу (BERT виводить англомовне label)
EN_TO_UA = {
    "allergy": "Алергія",
    "arthritis": "Артрит",
    "bronchial asthma": "Бронхіальна астма",
    "cervical spondylosis": "Шийний спондильоз",
    "chicken pox": "Вітряна віспа",
    "common cold": "Застуда",
    "dengue": "Денге",
    "diabetes": "Діабет",
    "drug reaction": "Реакція на ліки",
    "fungal infection": "Грибкова інфекція",
    "gastroesophageal reflux disease": "Рефлюксна хвороба стравоходу",
    "hypertension": "Гіпертонія",
    "impetigo": "Імпетиго",
    "jaundice": "Жовтяниця",
    "malaria": "Малярія",
    "migraine": "Мігрень",
    "peptic ulcer disease": "Виразка шлунку/дванадцятипалої кишки",
    "pneumonia": "Пневмонія",
    "psoriasis": "Псоріаз",
    "typhoid": "Тиф",
    "urinary tract infection": "Інфекція сечовивідних шляхів",
    "varicose veins": "Варикозне розширення вен"
}

# Повний набір українських рекомендацій
HARD_CODED_RECOMMENDATIONS = {
    "allergy": (
        "При даних симптомах найімовірніше, що у вас: Алергія.\n"
        "РЕКОМЕНДАЦІЯ: Уникайте алергенів, провітрюйте приміщення.\n"
        "САМОЛІКУВАННЯ: Антигістамінні (за потреби), промивання носа сольовим розчином.\n"
        "КОЛИ ЗВЕРТАТИСЯ ДО ЛІКАРЯ: При сильних набряках, висипах або ускладненому диханні."
    ),
    "arthritis": (
        "При даних симптомах найімовірніше, що у вас: Артрит.\n"
        "РЕКОМЕНДАЦІЯ: Зменшити навантаження на суглоби, робити легку гімнастику.\n"
        "САМОЛІКУВАННЯ: Протизапальні мазі, теплові компреси, знеболювальні за інструкцією.\n"
        "КОЛИ ЗВЕРТАТИСЯ ДО ЛІКАРЯ: Якщо біль і набряк не минають кілька днів чи погіршуються."
    ),
    "bronchial asthma": (
        "При даних симптомах найімовірніше, що у вас: Бронхіальна астма.\n"
        "РЕКОМЕНДАЦІЯ: Уникайте алергенів, тримайте при собі інгалятор.\n"
        "САМОЛІКУВАННЯ: Контроль дихання, легкі дихальні вправи.\n"
        "КОЛИ ЗВЕРТАТИСЯ ДО ЛІКАРЯ: При погіршенні, частих нападах або недостатній ефективності інгалятора."
    ),
    "cervical spondylosis": (
        "При даних симптомах найімовірніше, що у вас: Шийний спондильоз.\n"
        "РЕКОМЕНДАЦІЯ: Уникайте різких рухів шиї, робіть спеціальну гімнастику.\n"
        "САМОЛІКУВАННЯ: Масаж шийного відділу, теплові компреси.\n"
        "КОЛИ ЗВЕРТАТИСЯ ДО ЛІКАРЯ: Якщо біль посилюється, з’являється оніміння рук чи запаморочення."
    ),
    "chicken pox": (
        "При даних симптомах найімовірніше, що у вас: Вітряна віспа.\n"
        "РЕКОМЕНДАЦІЯ: Дотримуватися постільного режиму, обробляти висипи.\n"
        "САМОЛІКУВАННЯ: Антигістамінні (проти свербежу), зеленка або інші антисептики на висип.\n"
        "КОЛИ ЗВЕРТАТИСЯ ДО ЛІКАРЯ: При ускладненнях, високій температурі, поширених інфікованих висипах."
    ),
    "common cold": (
        "При даних симптомах найімовірніше, що у вас: Застуда.\n"
        "РЕКОМЕНДАЦІЯ: Відпочивайте, пийте багато теплої рідини (чай, вода). Уникайте переохолодження.\n"
        "САМОЛІКУВАННЯ: За потреби приймати жарознижувальні (парацетамол) та краплі від нежитю.\n"
        "КОЛИ ЗВЕРТАТИСЯ ДО ЛІКАРЯ: Якщо температура утримується понад 3 дні або стан погіршується."
    ),
    "dengue": (
        "При даних симптомах найімовірніше, що у вас: Денге.\n"
        "РЕКОМЕНДАЦІЯ: Пийте багато рідини, уникайте зневоднення.\n"
        "САМОЛІКУВАННЯ: Жарознижувальні (уникайте аспірину), відпочинок.\n"
        "КОЛИ ЗВЕРТАТИСЯ ДО ЛІКАРЯ: При сильному болю у животі, кривавих виділеннях або різкому погіршенні стану."
    ),
    "diabetes": (
        "При даних симптомах найімовірніше, що у вас: Діабет.\n"
        "РЕКОМЕНДАЦІЯ: Перевірка рівня цукру, дотримання дієти з мінімумом швидких вуглеводів.\n"
        "САМОЛІКУВАННЯ: Регулярна активність, контроль вуглеводів, можливо цукрознижувальні препарати.\n"
        "КОЛИ ЗВЕРТАТИСЯ ДО ЛІКАРЯ: Якщо рівень цукру неконтрольовано високий, з’являється запаморочення чи блювання."
    ),
    "drug reaction": (
        "При даних симптомах найімовірніше, що у вас: Реакція на ліки.\n"
        "РЕКОМЕНДАЦІЯ: Припинити прийом підозрюваних препаратів.\n"
        "САМОЛІКУВАННЯ: Якщо незначні симптоми — спостерігайте, використовуйте антигістамінні.\n"
        "КОЛИ ЗВЕРТАТИСЯ ДО ЛІКАРЯ: Негайно при сильних набряках, ускладненому диханні чи висипах."
    ),
    "fungal infection": (
        "При даних симптомах найімовірніше, що у вас: Грибкова інфекція.\n"
        "РЕКОМЕНДАЦІЯ: Тримайте уражені ділянки сухими, уникайте травмування шкіри.\n"
        "САМОЛІКУВАННЯ: Протигрибкові мазі або креми (клотримазол, тощо).\n"
        "КОЛИ ЗВЕРТАТИСЯ ДО ЛІКАРЯ: Якщо інфекція поширюється чи не реагує на місцеве лікування."
    ),
    "gastroesophageal reflux disease": (
        "При даних симптомах найімовірніше, що у вас: Рефлюксна хвороба стравоходу.\n"
        "РЕКОМЕНДАЦІЯ: Уникайте їжі перед сном, зменште гостре та жирне.\n"
        "САМОЛІКУВАННЯ: Антациди, ІПП (омепразол) за призначенням.\n"
        "КОЛИ ЗВЕРТАТИСЯ ДО ЛІКАРЯ: Якщо відчуваєте часту печію або біль у грудях, що не минає."
    ),
    "hypertension": (
        "При даних симптомах найімовірніше, що у вас: Гіпертонія.\n"
        "РЕКОМЕНДАЦІЯ: Контролюйте тиск, обмежте сіль та каву.\n"
        "САМОЛІКУВАННЯ: Релаксаційні вправи, трав'яні чаї, заспокійливе.\n"
        "КОЛИ ЗВЕРТАТИСЯ ДО ЛІКАРЯ: При різкому підвищенні тиску, сильному головному болю чи порушеннях зору."
    ),
    "impetigo": (
        "При даних симптомах найімовірніше, що у вас: Імпетиго.\n"
        "РЕКОМЕНДАЦІЯ: Дезінфікуйте уражені ділянки, дотримуйтесь гігієни.\n"
        "САМОЛІКУВАННЯ: Антисептичні мазі, захист від розчухування.\n"
        "КОЛИ ЗВЕРТАТИСЯ ДО ЛІКАРЯ: Якщо висип розширюється чи супроводжується лихоманкою."
    ),
    "jaundice": (
        "При даних симптомах найімовірніше, що у вас: Жовтяниця.\n"
        "РЕКОМЕНДАЦІЯ: Контролюйте функцію печінки, уникайте жирного.\n"
        "САМОЛІКУВАННЯ: Пийте багато води, легка дієта.\n"
        "КОЛИ ЗВЕРТАТИСЯ ДО ЛІКАРЯ: Терміново, оскільки потрібне обстеження для встановлення причини."
    ),
    "malaria": (
        "При даних симптомах найімовірніше, що у вас: Малярія.\n"
        "РЕКОМЕНДАЦІЯ: Терміново зверніться до лікаря, адже це може бути небезпечно.\n"
        "САМОЛІКУВАННЯ: Обмежене, оскільки потрібні протималярійні засоби.\n"
        "КОЛИ ЗВЕРТАТИСЯ ДО ЛІКАРЯ: Негайно, адже малярія вимагає специфічного лікування."
    ),
    "migraine": (
        "При даних симптомах найімовірніше, що у вас: Мігрень.\n"
        "РЕКОМЕНДАЦІЯ: Перебувайте у темному тихому приміщенні, уникайте стресу.\n"
        "САМОЛІКУВАННЯ: Знеболювальні (ібупрофен, парацетамол) за потреби.\n"
        "КОЛИ ЗВЕРТАТИСЯ ДО ЛІКАРЯ: Якщо біль триває понад 3 дні, супроводжується нудотою чи порушенням зору."
    ),
    "peptic ulcer disease": (
        "При даних симптомах найімовірніше, що у вас: Виразкова хвороба.\n"
        "РЕКОМЕНДАЦІЯ: Уникайте гострого, кави та алкоголю.\n"
        "САМОЛІКУВАННЯ: Антациди або ІПП (омепразол) можуть полегшити.\n"
        "КОЛИ ЗВЕРТАТИСЯ ДО ЛІКАРЯ: При різких болях, блюванні з кров’ю чи різкому схудненні."
    ),
    "pneumonia": (
        "При даних симптомах найімовірніше, що у вас: Пневмонія.\n"
        "РЕКОМЕНДАЦІЯ: Негайно зверніться до лікаря для обстеження, можливе застосування антибіотиків.\n"
        "САМОЛІКУВАННЯ: Постільний режим, багато рідини. Самолікування небезпечне.\n"
        "КОЛИ ЗВЕРТАТИСЯ ДО ЛІКАРЯ: Відразу, щоб уникнути ускладнень."
    ),
    "psoriasis": (
        "При даних симптомах найімовірніше, що у вас: Псоріаз.\n"
        "РЕКОМЕНДАЦІЯ: Зволожуйте шкіру, уникайте подразників.\n"
        "САМОЛІКУВАННЯ: Місцеві мазі (кортикостероїди), легкі заспокійливі ванни.\n"
        "КОЛИ ЗВЕРТАТИСЯ ДО ЛІКАРЯ: При розширених ураженнях чи загостренні."
    ),
    "typhoid": (
        "При даних симптомах найімовірніше, що у вас: Тиф.\n"
        "РЕКОМЕНДАЦІЯ: Пити багато води, дотримуватися дієти (легкозасвоювані страви).\n"
        "САМОЛІКУВАННЯ: Лише жарознижувальні, але потрібне обстеження.\n"
        "КОЛИ ЗВЕРТАТИСЯ ДО ЛІКАРЯ: Негайно, оскільки тиф небезпечний без антибіотиків."
    ),
    "urinary tract infection": (
        "При даних симптомах найімовірніше, що у вас: Інфекція сечовивідних шляхів.\n"
        "РЕКОМЕНДАЦІЯ: Пити багато рідини, не терпіти позивів до сечовипускання.\n"
        "САМОЛІКУВАННЯ: Журавлиний сік, теплі ванночки. Можливі легкі препарати.\n"
        "КОЛИ ЗВЕРТАТИСЯ ДО ЛІКАРЯ: Якщо біль або печіння посилюються, з’являється кров у сечі."
    ),
    "varicose veins": (
        "При даних симптомах найімовірніше, що у вас: Варикозне розширення вен.\n"
        "РЕКОМЕНДАЦІЯ: Уникайте довготривалого стояння, носіть компресійні панчохи.\n"
        "САМОЛІКУВАННЯ: Масаж, контрастні ванночки для ніг.\n"
        "КОЛИ ЗВЕРТАТИСЯ ДО ЛІКАРЯ: При сильному набряку, болю чи появі виразок на шкірі."
    )
}


@app.on_event("startup")
def load_models():
    global classifier_model
    global classifier_tokenizer

    # Завантажуємо BERT для класифікації (TensorFlow)
    model_path_class = os.path.join(os.path.dirname(__file__), "model")
    print(">> [INFO] Loading BERT classifier...")
    classifier_tokenizer = AutoTokenizer.from_pretrained(model_path_class)
    classifier_model = TFAutoModelForSequenceClassification.from_pretrained(model_path_class)
    print(">> [INFO] BERT loaded.\n")


@app.post("/predict")
def predict(data: SymptomRequest):
    """
    1) Визначаємо мову користувача (uk/en/...).
    2) Якщо uk -> перекладаємо symptoms -> en для класифікації.
    3) Класифікуємо (BERT) -> отримуємо en_diagnosis.
    4) Дістаємо захардкожений текст (український) із HARD_CODED_RECOMMENDATIONS.
    5) Якщо користувач укр -> повертаємо напряму. Якщо інша мова -> перекладаємо.
    """
    user_text = data.symptoms.strip()

    # Крок 1. Виявляємо мову
    detection = translator.detect(user_text)
    user_lang = detection.lang  # 'uk', 'en', etc.

    # Крок 2. Якщо укр, перекладаємо -> en
    if user_lang == 'uk':
        text_for_classification = translator.translate(user_text, src='uk', dest='en').text
    else:
        text_for_classification = user_text

    # Крок 3. Класифікація (англійською) через BERT
    inputs = classifier_tokenizer(
        text_for_classification,
        return_tensors="tf",
        truncation=True,
        max_length=128
    )
    outputs = classifier_model(**inputs)
    logits = outputs.logits
    predicted_class_id = int(tf.math.argmax(logits, axis=-1)[0])
    en_diagnosis = id2label.get(predicted_class_id, "Unknown")

    # Крок 4. Дістаємо український текст рекомендації із словника
    uk_advice = HARD_CODED_RECOMMENDATIONS.get(en_diagnosis, (
        "Немає готових рекомендацій для цього діагнозу. "
        "Радимо звернутися до лікаря."
    ))

    # Крок 5. Якщо користувач писав укр — повертаємо напряму, інакше перекладаємо
    if user_lang == 'uk':
        return {
            "language_detected": "uk",
            "diagnosis_en": en_diagnosis,
            "advice_uk": uk_advice,
            "message": uk_advice
        }
    else:
        # Перекладаємо укр-текст на мову користувача (user_lang)
        advice_translated = translator.translate(uk_advice, src='uk', dest=user_lang).text
        return {
            "language_detected": user_lang,
            "diagnosis_en": en_diagnosis,
            "advice_uk": uk_advice,
            "advice_in_user_lang": advice_translated,
            "message": advice_translated
        }


if __name__ == "__main__":
    uvicorn.run("main:app", host="0.0.0.0", port=8000, reload=True)
